### 一种在有限带宽下提高gossip通信效率的优化方法

#### 技术领域

本发明涉及软件工程领域，具体的说是一种在有限带宽下提高gossip通信效率的优化方法

#### 背景技术

随着互联网技术的飞速发展，服务的规模也越来越大，特别的，随着微服务架构的发展，企业应用越来越多的把运行在同一个应用中的服务垂直拆分为多个
独立的子服务，子服务的粒度越来越小，部署的实例数越来越多，同时为了充分利用服务资源，在流量高峰期时进行动态扩容，在流量降低时进行缩容，
这最终导致微服务之间的服务发现和服务自治越来越困难；
服务在动态调整过程中，服务的数量和行为都会相应的改变，服务随时会加入或者退出整个系统，一般的做法是使用一个服务注册中心，
实现服务的自动注册和自动发现，但这种方法存在对注册中心的依赖，无法有效的做到一个服务自治。当前逐步流行的去中心化最终一致性协议gossip，
在某种程度上可以解决大规模微服务自治问题，但是当前使用的gossip协议，在数据通信效率和收敛速度方面都有待提升。

#### 发明内容
本发明针对当前技术发展的不足之处，提供了一种在有限带宽下提高gossip通信效率的优化方法。
本发明所述的一种在有限带宽下提高gossip通信效率的优化方法，具体的解决上述技术问题的方案如下：
相对于gossip反墒协议的精确匹配流程需要足够的带宽用来传输全量的数据，本方法只需要对比时间戳，传输部分差异化数据；在保证收敛速度的同时最大化的减少了通信数据量；
相对于gossip反墒协议的Scuttlebutt使用版本号进行对比，生成差异化数据，本方法使用时间戳对比生成差异化数据，能更快地更新老数据，更快的收敛,
同时在通信开始阶段只传输最大时间戳集合的摘要信息，在系统达到最终一致性后，减少节点间的通信数据量；

实现在有限带宽下提高gossip通信效率的优化方法具体过程包括如下步骤：
步骤1、全局定义
步骤1.0、定义P = {p, q, ......}为系统各通信节点的集合；p, q,...分别对应各通信节点；
步骤1.1、定义m(k) = (v, ts)，其中ts是时间戳，k为键，v为k对应的值，整个表示在ts时间，k被对应到v所指定的值；
步骤1.2、定义Up(r)为p节点保存的r节点的所有m(k) = (v, ts)的信息；Up(r)(k)表示其中一个k对应的（v, ts)信息；
步骤2、节点约束
步骤2.0、每个节点只能更新属于自己节点的m(k) = (v, ts)信息，其他节点的m(k) = (v, ts)只能通过gossip通信被动更新；
步骤2.1、每个节点更新属于自己节点的m(k) = (v, ts)时，ts是获取的最新的时间戳，在节点时间不回退的情况下，可以保证每次更新，ts都是最大值，
因此节点Up(p)(k) = （v, ts）不存在相同的情况；
步骤3、计算节点最大时间戳集合
步骤3.0、在某一个轮次，其中p节点和q节点开始gossip通信
步骤3.1、p节点计算集合Up(ts) = {(r, max(Up(r))) | r belong to P}，其中max(Up(r))计算的是其中p节点保存的r节点数据的m(k) = (v, ts)中ts的最大值的集合；
步骤4、计算md5摘要
步骤4.0、计算上一步U(ts)的md5摘要，发送给q节点
步骤4.1、q节点同时计算集合Uq(ts) = {(r, max(Uq(r))) | r belong to P}的md5摘要，如果一样，表示两个节点的版本一致，可以终止通信
步骤4.2、如果不一致，q对Uq(ts)进行从大到小排序，根据数据包大小的限制，随机选取Uq(ts)子集发送到节点p；此处只需要计算所有节点的最大ts的md5摘要，在系统处于最终
一致性时，只需要传输摘要信息即可，减少了通信数据量；
步骤5、计算差分数据，节点p对比本地集合Up(r)，计算差分数据集, delta = {(r, k, v, ts) | Up(r)(k) = (v, ts) where ts > max(Uq(r))}，由于数据包大小限制的情况下，不能全量的发送所有差分数据，计算delta集合中ts于当前时间戳相差最大的子集发送给q；
步骤6、同时p把{ts | Up(r)(k) = (v, ts) where ts < max(Uq(r))} 发送给q；
步骤7、q接收到差分数据，跟本地数据进行合并，合并最新的数据；
步骤8、q按照第八步相同的处理方式，发送差分数据给p；
步骤9、以上完成一轮的数据交换，根据gossip协议收敛性证明，在Clog(n)轮次后，每个节点都会获取到所有节点的最新(r, k, v, ts)信息；

